# P0优先级功能技术设计文档

## 文档信息
- **版本**: v1.0
- **创建日期**: 2026-02-08
- **设计者**: Team Lead
- **状态**: 已完成

## 1. 概述

本文档详细设计了邮箱客户端P0优先级的6大核心功能的技术实现方案。

### 1.1 P0功能列表
1. 回复邮件 (Reply/Reply All)
2. 转发邮件 (Forward)
3. 草稿管理 (Drafts)
4. 邮件删除 (Delete/Trash)
5. 垃圾邮件过滤 (Spam Filter)
6. 邮件签名 (Signatures)

### 1.2 设计原则
- 保持与现有架构一致
- 最小化代码侵入性
- 优先使用现有组件
- 确保向后兼容
- 注重性能和用户体验

---

## 2. 数据库Schema扩展设计

### 2.1 扩展 emails 表

需要在现有 emails 表中添加以下字段：

```sql
ALTER TABLE emails ADD COLUMN is_draft BOOLEAN DEFAULT 0;
ALTER TABLE emails ADD COLUMN is_deleted BOOLEAN DEFAULT 0;
ALTER TABLE emails ADD COLUMN is_spam BOOLEAN DEFAULT 0;
ALTER TABLE emails ADD COLUMN in_reply_to TEXT;
ALTER TABLE emails ADD COLUMN references TEXT;
ALTER TABLE emails ADD COLUMN thread_id TEXT;
ALTER TABLE emails ADD COLUMN deleted_at DATETIME;
```

**字段说明**：
- `is_draft`: 标记是否为草稿
- `is_deleted`: 软删除标记
- `is_spam`: 垃圾邮件标记
- `in_reply_to`: 回复的邮件Message-ID
- `references`: 邮件引用链（用于线程）
- `thread_id`: 邮件线程ID
- `deleted_at`: 删除时间戳

### 2.2 创建 signatures 表

```sql
CREATE TABLE IF NOT EXISTS signatures (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  content_text TEXT,
  content_html TEXT,
  is_default BOOLEAN DEFAULT 0,
  account_email TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明**：
- `name`: 签名名称
- `content_text`: 纯文本签名内容
- `content_html`: HTML签名内容
- `is_default`: 是否为默认签名
- `account_email`: 关联的账户邮箱

### 2.3 创建 spam_rules 表

```sql
CREATE TABLE IF NOT EXISTS spam_rules (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  rule_type TEXT NOT NULL,
  pattern TEXT NOT NULL,
  action TEXT NOT NULL,
  is_enabled BOOLEAN DEFAULT 1,
  priority INTEGER DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明**：
- `rule_type`: 规则类型 (sender, keyword, header, link)
- `pattern`: 匹配模式
- `action`: 动作 (mark_spam, delete, move)
- `is_enabled`: 是否启用
- `priority`: 优先级

### 2.4 创建 blacklist 和 whitelist 表

```sql
CREATE TABLE IF NOT EXISTS blacklist (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email_address TEXT UNIQUE NOT NULL,
  domain TEXT,
  reason TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS whitelist (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email_address TEXT UNIQUE NOT NULL,
  domain TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 2.5 创建索引

```sql
CREATE INDEX IF NOT EXISTS idx_emails_is_draft ON emails(is_draft);
CREATE INDEX IF NOT EXISTS idx_emails_is_deleted ON emails(is_deleted);
CREATE INDEX IF NOT EXISTS idx_emails_is_spam ON emails(is_spam);
CREATE INDEX IF NOT EXISTS idx_emails_thread_id ON emails(thread_id);
CREATE INDEX IF NOT EXISTS idx_signatures_account ON signatures(account_email);
CREATE INDEX IF NOT EXISTS idx_spam_rules_type ON spam_rules(rule_type);
```

---

## 3. 功能详细设计

### 3.1 回复邮件功能 (Reply/Reply All)

#### 3.1.1 CLI命令设计

**命令**: `mail-client reply <email-id> [options]`

**选项**:
- `--all`: 回复全部收件人
- `--body <text>`: 回复内容（非交互模式）
- `--editor`: 使用编辑器（交互模式）

**示例**:
```bash
mail-client reply 123 --all
mail-client reply 123 --body "Thanks for your email"
```

#### 3.1.2 实现逻辑

1. **获取原邮件**
   - 从数据库读取原邮件内容
   - 解析发件人、收件人、主题等信息

2. **构建回复邮件**
   - 设置收件人：
     - Reply: 原发件人
     - Reply All: 原发件人 + 所有收件人（排除自己）
   - 设置主题：`Re: <原主题>`
   - 设置邮件头：
     - `In-Reply-To`: 原邮件的Message-ID
     - `References`: 原邮件的References + Message-ID
   - 引用原文：
     - 添加引用标记（`> `）
     - 包含原邮件内容

3. **发送邮件**
   - 使用现有的 SMTPClient 发送
   - 保存到已发送文件夹

#### 3.1.3 文件结构

```
src/cli/commands/reply.js          # 回复命令实现
src/smtp/composer.js                # 扩展：添加回复相关方法
src/utils/email-formatter.js       # 新建：邮件格式化工具
```

#### 3.1.4 核心代码结构

```javascript
// src/cli/commands/reply.js
async function replyCommand(emailId, options) {
  // 1. 获取原邮件
  const originalEmail = await emailModel.findById(emailId);

  // 2. 构建回复邮件
  const composer = new EmailComposer();
  composer
    .setTo(options.all ? getAllRecipients(originalEmail) : [originalEmail.from_address])
    .setSubject(`Re: ${originalEmail.subject}`)
    .setInReplyTo(originalEmail.message_id)
    .setReferences(buildReferences(originalEmail));

  // 3. 添加引用原文
  const quotedBody = quoteOriginalEmail(originalEmail);

  // 4. 获取用户回复内容
  const replyBody = await getUserReplyContent(options);

  // 5. 组合并发送
  composer.setBody(replyBody + '\n\n' + quotedBody);
  await smtpClient.sendEmail(composer.compose());
}
```

---

### 3.2 转发邮件功能 (Forward)

#### 3.2.1 CLI命令设计

**命令**: `mail-client forward <email-id> [options]`

**选项**:
- `--to <emails>`: 转发给谁（必需）
- `--body <text>`: 转发备注
- `--no-attachments`: 不包含附件

**示例**:
```bash
mail-client forward 123 --to user@example.com
mail-client forward 123 --to user@example.com --body "FYI"
```

#### 3.2.2 实现逻辑

1. **获取原邮件**
   - 读取邮件内容和附件

2. **构建转发邮件**
   - 设置主题：`Fwd: <原主题>`
   - 添加转发标记
   - 包含原邮件完整内容
   - 附加原邮件的附件

3. **发送邮件**

#### 3.2.3 文件结构

```
src/cli/commands/forward.js         # 转发命令实现
```

---

### 3.3 草稿管理功能 (Drafts)

#### 3.3.1 CLI命令设计

**命令集**:
- `mail-client draft save [options]`: 保存草稿
- `mail-client draft list`: 列出所有草稿
- `mail-client draft edit <draft-id>`: 编辑草稿
- `mail-client draft delete <draft-id>`: 删除草稿
- `mail-client draft send <draft-id>`: 发送草稿

**选项**:
```bash
mail-client draft save --to user@example.com --subject "Test" --body "Content"
mail-client draft list
mail-client draft edit 5
mail-client draft send 5
```

#### 3.3.2 实现逻辑

1. **保存草稿**
   - 将邮件保存到本地数据库（is_draft=1）
   - 同步到IMAP服务器的Drafts文件夹

2. **编辑草稿**
   - 读取草稿内容
   - 允许用户修改
   - 更新数据库和服务器

3. **发送草稿**
   - 读取草稿
   - 通过SMTP发送
   - 标记草稿为已发送（is_draft=0）
   - 移动到Sent文件夹

4. **自动保存**
   - 在发送命令中添加自动保存逻辑
   - 定时保存草稿（可选）

#### 3.3.3 文件结构

```
src/cli/commands/draft.js           # 草稿管理命令
src/storage/models/email.js         # 扩展：添加草稿相关方法
src/imap/sync.js                    # 扩展：草稿同步逻辑
```

---

### 3.4 邮件删除功能 (Delete/Trash)

#### 3.4.1 CLI命令设计

**命令集**:
- `mail-client delete <email-id>`: 删除邮件（移到垃圾箱）
- `mail-client delete <email-id> --permanent`: 永久删除
- `mail-client trash list`: 查看垃圾箱
- `mail-client trash empty`: 清空垃圾箱
- `mail-client trash restore <email-id>`: 恢复邮件

**示例**:
```bash
mail-client delete 123
mail-client delete 123 --permanent
mail-client trash list
mail-client trash empty
mail-client trash restore 123
```

#### 3.4.2 实现逻辑

1. **软删除（移到垃圾箱）**
   - 设置 is_deleted=1, deleted_at=NOW()
   - IMAP操作：移动到Trash文件夹
   - 本地数据库标记

2. **永久删除**
   - IMAP操作：设置\\Deleted标志并EXPUNGE
   - 本地数据库：物理删除记录
   - 删除关联的附件文件

3. **恢复邮件**
   - 设置 is_deleted=0
   - IMAP操作：移回原文件夹
   - 更新数据库

4. **清空垃圾箱**
   - 批量永久删除所有已删除邮件
   - 清理附件文件

#### 3.4.3 文件结构

```
src/cli/commands/delete.js          # 删除命令
src/cli/commands/trash.js           # 垃圾箱管理命令
src/imap/client.js                  # 扩展：添加删除操作
src/storage/models/email.js         # 扩展：删除相关方法
```

---

### 3.5 垃圾邮件过滤功能 (Spam Filter)

#### 3.5.1 CLI命令设计

**命令集**:
- `mail-client spam mark <email-id>`: 标记为垃圾邮件
- `mail-client spam unmark <email-id>`: 取消垃圾邮件标记
- `mail-client spam list`: 查看垃圾邮件
- `mail-client spam blacklist add <email>`: 添加到黑名单
- `mail-client spam blacklist remove <email>`: 从黑名单移除
- `mail-client spam whitelist add <email>`: 添加到白名单
- `mail-client spam filter`: 手动运行垃圾邮件过滤

**示例**:
```bash
mail-client spam mark 123
mail-client spam blacklist add spam@example.com
mail-client spam whitelist add friend@example.com
```

#### 3.5.2 实现逻辑

1. **垃圾邮件检测引擎**
   - 黑名单检查（发件人邮箱/域名）
   - 白名单检查（优先级最高）
   - 关键词检测（主题和正文）
   - 可疑链接检测
   - 邮件头分析

2. **检测规则**
   ```javascript
   const spamRules = [
     { type: 'blacklist', check: checkBlacklist },
     { type: 'keyword', check: checkKeywords },
     { type: 'link', check: checkSuspiciousLinks },
     { type: 'header', check: checkHeaders }
   ];
   ```

3. **自动过滤**
   - 在邮件同步时自动检测
   - 标记为垃圾邮件
   - 移动到Spam文件夹

4. **学习型过滤**
   - 记录用户标记的垃圾邮件特征
   - 自动更新规则库

#### 3.5.3 文件结构

```
src/spam/filter.js                  # 垃圾邮件过滤引擎
src/spam/rules.js                   # 检测规则定义
src/spam/detector.js                # 检测器实现
src/cli/commands/spam.js            # 垃圾邮件管理命令
src/storage/models/spam.js          # 垃圾邮件数据模型
```

#### 3.5.4 核心算法

```javascript
// src/spam/filter.js
class SpamFilter {
  async detectSpam(email) {
    // 1. 白名单检查（直接通过）
    if (await this.isWhitelisted(email.from_address)) {
      return false;
    }

    // 2. 黑名单检查
    if (await this.isBlacklisted(email.from_address)) {
      return true;
    }

    // 3. 规则检查
    let spamScore = 0;
    for (const rule of this.rules) {
      if (rule.check(email)) {
        spamScore += rule.weight;
      }
    }

    // 4. 判断是否为垃圾邮件
    return spamScore >= this.threshold;
  }
}
```

---

### 3.6 邮件签名功能 (Signatures)

#### 3.6.1 CLI命令设计

**命令集**:
- `mail-client signature create`: 创建签名
- `mail-client signature list`: 列出所有签名
- `mail-client signature edit <id>`: 编辑签名
- `mail-client signature delete <id>`: 删除签名
- `mail-client signature set-default <id>`: 设置默认签名

**示例**:
```bash
mail-client signature create --name "Work" --text "Best regards, John"
mail-client signature list
mail-client signature set-default 1
```

#### 3.6.2 实现逻辑

1. **签名管理**
   - 创建、编辑、删除签名
   - 支持纯文本和HTML格式
   - 设置默认签名

2. **自动插入签名**
   - 发送邮件时自动添加
   - 回复/转发时添加
   - 草稿中包含签名

3. **签名模板变量**
   ```
   {{name}}      - 用户名
   {{email}}     - 邮箱地址
   {{date}}      - 当前日期
   {{time}}      - 当前时间
   ```

#### 3.6.3 文件结构

```
src/signatures/manager.js           # 签名管理器
src/signatures/template.js          # 签名模板处理
src/cli/commands/signature.js       # 签名管理命令
src/storage/models/signature.js     # 签名数据模型
src/smtp/composer.js                # 扩展：自动添加签名
```

---

## 4. 集成点设计

### 4.1 EmailComposer 扩展

在 `src/smtp/composer.js` 中添加以下方法：

```javascript
class EmailComposer {
  // 现有方法...

  // 新增方法
  setInReplyTo(messageId) {
    this.emailData.inReplyTo = messageId;
    return this;
  }

  setReferences(references) {
    this.emailData.references = references;
    return this;
  }

  addSignature(signature) {
    if (signature.content_html && this.emailData.html) {
      this.emailData.html += '\n\n' + signature.content_html;
    }
    if (signature.content_text) {
      this.emailData.text += '\n\n' + signature.content_text;
    }
    return this;
  }

  quoteOriginalEmail(originalEmail) {
    const quoted = originalEmail.body_text
      .split('\n')
      .map(line => '> ' + line)
      .join('\n');
    return quoted;
  }
}
```

### 4.2 IMAP Client 扩展

在 `src/imap/client.js` 中添加：

```javascript
class IMAPClient {
  // 现有方法...

  // 新增方法
  async moveEmail(uid, targetFolder) {
    // 实现邮件移动
  }

  async deleteEmail(uid, permanent = false) {
    // 实现邮件删除
  }

  async saveDraft(emailData) {
    // 保存草稿到Drafts文件夹
  }
}
```

### 4.3 Email Model 扩展

在 `src/storage/models/email.js` 中添加：

```javascript
class EmailModel {
  // 现有方法...

  // 新增方法
  async findDrafts() {
    // 查询所有草稿
  }

  async markAsDeleted(id) {
    // 软删除
  }

  async markAsSpam(id) {
    // 标记为垃圾邮件
  }

  async findDeleted() {
    // 查询已删除邮件
  }

  async findSpam() {
    // 查询垃圾邮件
  }
}
```

---

## 5. CLI命令注册

在 `src/cli/index.js` 中注册新命令：

```javascript
// 回复命令
program
  .command('reply <email-id>')
  .option('--all', 'Reply to all recipients')
  .option('--body <text>', 'Reply body')
  .action(replyCommand);

// 转发命令
program
  .command('forward <email-id>')
  .option('--to <emails>', 'Forward to (required)')
  .option('--body <text>', 'Forward message')
  .action(forwardCommand);

// 草稿命令
program
  .command('draft <action>')
  .description('Manage drafts (save|list|edit|delete|send)')
  .action(draftCommand);

// 删除命令
program
  .command('delete <email-id>')
  .option('--permanent', 'Permanently delete')
  .action(deleteCommand);

// 垃圾箱命令
program
  .command('trash <action>')
  .description('Manage trash (list|empty|restore)')
  .action(trashCommand);

// 垃圾邮件命令
program
  .command('spam <action>')
  .description('Manage spam (mark|unmark|list|blacklist|whitelist)')
  .action(spamCommand);

// 签名命令
program
  .command('signature <action>')
  .description('Manage signatures (create|list|edit|delete|set-default)')
  .action(signatureCommand);
```

---

## 6. 实施优先级

### 阶段1：基础功能（必须）
1. 数据库Schema扩展
2. 回复/转发功能
3. 删除/垃圾箱功能

### 阶段2：核心功能（重要）
4. 草稿管理
5. 邮件签名

### 阶段3：高级功能（增强）
6. 垃圾邮件过滤

---

## 7. 测试计划

### 7.1 单元测试
- 每个新增模块的单元测试
- 数据库操作测试
- 邮件格式化测试

### 7.2 集成测试
- 回复/转发流程测试
- 草稿保存和发送测试
- 删除和恢复测试
- 垃圾邮件检测测试

### 7.3 端到端测试
- 完整的邮件生命周期测试
- 多账户场景测试

---

## 8. 风险与注意事项

### 8.1 IMAP兼容性
- 不同邮件服务器的IMAP实现可能有差异
- 需要测试主流邮件服务（Gmail, Outlook, QQ等）

### 8.2 数据迁移
- 现有数据库需要平滑迁移
- 保证数据完整性

### 8.3 性能考虑
- 垃圾邮件检测不应影响同步速度
- 大量邮件删除时的性能优化

### 8.4 错误处理
- 网络异常处理
- IMAP操作失败的回滚机制

---

## 9. 文档输出

完成开发后需要提供：
1. 用户使用手册
2. API文档
3. 数据库Schema文档
4. 故障排查指南

---

## 附录：文件清单

### 新建文件
```
src/cli/commands/reply.js
src/cli/commands/forward.js
src/cli/commands/draft.js
src/cli/commands/delete.js
src/cli/commands/trash.js
src/cli/commands/spam.js
src/cli/commands/signature.js
src/spam/filter.js
src/spam/rules.js
src/spam/detector.js
src/signatures/manager.js
src/signatures/template.js
src/storage/models/spam.js
src/storage/models/signature.js
src/storage/migrations/002_p0_features.js
src/utils/email-formatter.js
```

### 修改文件
```
src/cli/index.js                    # 注册新命令
src/smtp/composer.js                # 扩展功能
src/imap/client.js                  # 扩展IMAP操作
src/imap/sync.js                    # 扩展同步逻辑
src/storage/models/email.js         # 扩展邮件模型
```

---

**文档结束**

此设计文档为P0功能开发提供了完整的技术指导。开发团队可以基于此文档开始实施。
