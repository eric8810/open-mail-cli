# P1优先级功能技术设计文档

## 文档信息
- **版本**: v1.0
- **创建日期**: 2026-02-08
- **设计者**: Product Design Expert
- **状态**: 已完成

## 1. 概述

本文档详细设计了邮箱客户端P1优先级的核心组织和管理功能的技术实现方案。

### 1.1 P1功能列表
1. 邮件标签/标记系统 (Tags/Flags)
2. 邮件过滤规则引擎 (Filters/Rules)
3. 文件夹管理增强 (Folder Management)
4. 联系人管理系统 (Address Book)
5. 多账户支持 (Multi-Account)
6. 邮件线程视图 (Conversation Threading)
7. 高级搜索和快速过滤 (Advanced Search)
8. 同步增强 (Sync Enhancement)

### 1.2 设计原则
- 保持与现有架构一致
- 模块化设计，便于维护和扩展
- 优先使用现有组件
- 确保向后兼容
- 注重性能和用户体验
- 支持未来的多账户扩展

---

## 2. 数据库Schema扩展设计

### 2.1 创建 tags 表（标签系统）

```sql
CREATE TABLE IF NOT EXISTS tags (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL UNIQUE,
  color TEXT DEFAULT '#808080',
  description TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS email_tags (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email_id INTEGER NOT NULL,
  tag_id INTEGER NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (email_id) REFERENCES emails(id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE,
  UNIQUE(email_id, tag_id)
);
```

**字段说明**：
- `tags.name`: 标签名称（唯一）
- `tags.color`: 标签颜色（十六进制）
- `email_tags`: 邮件与标签的多对多关系表

### 2.2 扩展 emails 表（标记和线程）

```sql
ALTER TABLE emails ADD COLUMN is_starred BOOLEAN DEFAULT 0;
ALTER TABLE emails ADD COLUMN is_flagged BOOLEAN DEFAULT 0;
ALTER TABLE emails ADD COLUMN flag_type TEXT DEFAULT 'none';
ALTER TABLE emails ADD COLUMN thread_root_id TEXT;
ALTER TABLE emails ADD COLUMN thread_position INTEGER DEFAULT 0;
```

**字段说明**：
- `is_starred`: 星标标记
- `is_flagged`: 旗标标记
- `flag_type`: 旗标类型 (none, important, work, personal, todo, later)
- `thread_root_id`: 线程根邮件的Message-ID
- `thread_position`: 在线程中的位置

### 2.3 创建 filters 表（过滤规则）

```sql
CREATE TABLE IF NOT EXISTS filters (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  description TEXT,
  is_enabled BOOLEAN DEFAULT 1,
  priority INTEGER DEFAULT 0,
  match_all BOOLEAN DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS filter_conditions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  filter_id INTEGER NOT NULL,
  field TEXT NOT NULL,
  operator TEXT NOT NULL,
  value TEXT NOT NULL,
  FOREIGN KEY (filter_id) REFERENCES filters(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS filter_actions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  filter_id INTEGER NOT NULL,
  action_type TEXT NOT NULL,
  action_value TEXT,
  FOREIGN KEY (filter_id) REFERENCES filters(id) ON DELETE CASCADE
);
```

**字段说明**：
- `filters`: 过滤规则主表
- `filter_conditions`: 过滤条件（支持多条件）
  - `field`: from, to, subject, body, has_attachment, size
  - `operator`: contains, equals, starts_with, ends_with, greater_than, less_than
- `filter_actions`: 过滤动作
  - `action_type`: move_to_folder, add_tag, mark_read, mark_starred, delete, forward

### 2.4 创建 folders 表（文件夹管理）

```sql
CREATE TABLE IF NOT EXISTS folders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  account_id INTEGER DEFAULT 1,
  name TEXT NOT NULL,
  path TEXT NOT NULL,
  parent_id INTEGER,
  folder_type TEXT DEFAULT 'custom',
  is_favorite BOOLEAN DEFAULT 0,
  sort_order INTEGER DEFAULT 0,
  unread_count INTEGER DEFAULT 0,
  total_count INTEGER DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (parent_id) REFERENCES folders(id) ON DELETE CASCADE,
  FOREIGN KEY (account_id) REFERENCES accounts(id) ON DELETE CASCADE,
  UNIQUE(account_id, path)
);
```

**字段说明**：
- `folder_type`: inbox, sent, drafts, trash, spam, archive, custom
- `is_favorite`: 是否收藏
- `parent_id`: 父文件夹ID（支持嵌套）
- `path`: 完整路径（如 "INBOX/Work/Projects"）

### 2.5 创建 contacts 表（联系人管理）

```sql
