# P2功能技术设计文档

## 文档信息
- **项目名称**: Mail Client - P2功能
- **文档版本**: v1.0
- **创建日期**: 2026-02-08
- **设计人员**: Product Designer
- **文档类型**: 技术设计文档

## 1. 概述

### 1.1 设计目标
本文档详细设计P2优先级的三个核心功能模块：
1. **邮件模板系统** - 提高邮件撰写效率
2. **新邮件通知系统** - 实时邮件提醒
3. **邮件导入导出功能** - 数据迁移和备份

### 1.2 设计原则
- **模块化设计**: 每个功能独立模块，低耦合高内聚
- **向后兼容**: 不破坏现有功能
- **可扩展性**: 预留扩展接口
- **用户友好**: CLI交互简洁直观
- **性能优先**: 避免阻塞主流程

---

## 2. 邮件模板系统

### 2.1 功能概述

邮件模板系统允许用户创建、管理和使用预定义的邮件模板，支持变量替换，提高重复性邮件的撰写效率。

### 2.2 需求分析

#### 核心需求
- 创建邮件模板（主题、正文、附件）
- 编辑和删除模板
- 列出所有模板
- 使用模板快速撰写邮件
- 模板变量替换（如 {{name}}, {{date}}）
- 模板分类管理

#### 非功能需求
- 模板数量支持100+
- 变量替换响应时间 < 100ms
- 支持HTML和纯文本模板

### 2.3 技术架构

#### 2.3.1 模块结构

```
src/templates/
├── index.js              # 模板管理器主入口
├── manager.js            # 模板CRUD操作
├── parser.js             # 模板变量解析器
├── validator.js          # 模板验证
└── builtins.js           # 内置模板定义
```

#### 2.3.2 核心类设计

**TemplateManager类**
```javascript
class TemplateManager {
  constructor(db)

  // CRUD操作
  create(template)          // 创建模板
  update(id, template)      // 更新模板
  delete(id)                // 删除模板
  get(id)                   // 获取单个模板
  list(options)             // 列出模板（支持分类过滤）

  // 模板应用
  apply(templateId, variables)  // 应用模板并替换变量

  // 分类管理
  getCategories()           // 获取所有分类
  setCategory(id, category) // 设置模板分类
}
```

**TemplateParser类**
```javascript
class TemplateParser {
  constructor()

  parse(template, variables)    // 解析模板，替换变量
  extractVariables(template)    // 提取模板中的变量
  validateVariables(template, variables)  // 验证变量完整性

  // 内置变量
  getBuiltinVariables()         // 获取系统内置变量
}
```

### 2.4 数据库Schema设计

#### templates表
```sql
CREATE TABLE templates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL UNIQUE,
  category TEXT DEFAULT 'general',
  subject TEXT NOT NULL,
  body_text TEXT,
  body_html TEXT,
  attachments TEXT,              -- JSON数组，存储附件路径
  variables TEXT,                -- JSON数组，存储变量定义
  description TEXT,
  is_builtin BOOLEAN DEFAULT 0,  -- 是否为内置模板
  usage_count INTEGER DEFAULT 0, -- 使用次数统计
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_templates_category ON templates(category);
CREATE INDEX idx_templates_name ON templates(name);
```

### 2.5 CLI命令设计

#### 模板管理命令
```bash
# 创建模板
mail-client template create
mail-client template create --name "Meeting Request" --subject "Meeting: {{topic}}" --body "Hi {{name}}, ..."

# 列出模板
mail-client template list
mail-client template list --category work

# 查看模板详情
mail-client template show <id|name>

# 编辑模板
mail-client template edit <id|name>

# 删除模板
mail-client template delete <id|name>

# 使用模板发送邮件
mail-client send --template <id|name> --var name=John --var topic="Q1 Review"
```

### 2.6 模板变量系统

#### 内置变量
```javascript
{
  '{{date}}': new Date().toLocaleDateString(),
  '{{time}}': new Date().toLocaleTimeString(),
  '{{datetime}}': new Date().toLocaleString(),
  '{{year}}': new Date().getFullYear(),
  '{{month}}': new Date().getMonth() + 1,
  '{{day}}': new Date().getDate(),
  '{{sender_name}}': config.user.name,
  '{{sender_email}}': config.user.email
}
```

#### 自定义变量
- 用户在使用模板时通过 `--var key=value` 传入
- 支持多个变量
- 未提供的必需变量会提示用户输入

### 2.7 实现要点

1. **模板验证**
   - 检查必需字段（name, subject）
   - 验证变量语法 `{{variable_name}}`
   - 检查循环引用

2. **变量替换**
   - 使用正则表达式匹配 `{{...}}`
   - 支持默认值：`{{name|默认名称}}`
   - 支持条件渲染（未来扩展）

3. **性能优化**
   - 模板缓存机制
   - 变量预编译
   - 批量操作支持

4. **安全考虑**
   - 防止模板注入
   - 限制模板大小（< 1MB）
   - 附件路径验证

### 2.8 与现有系统集成

#### 集成点
1. **与发送命令集成**
   - 扩展 `send` 命令，添加 `--template` 选项
   - 模板内容填充到邮件编辑器

2. **与数据库集成**
   - 新增 templates 表
   - 使用现有 DatabaseManager

3. **与CLI集成**
   - 新增 `template` 命令组
   - 使用现有 inquirer 交互

---

## 3. 新邮件通知系统

### 3.1 功能概述

新邮件通知系统在收到新邮件时通过桌面通知、声音等方式提醒用户，支持通知过滤和免打扰模式。

### 3.2 需求分析

#### 核心需求
- 桌面通知（Windows/Linux/macOS）
- 声音提醒
- 通知内容预览（发件人、主题）
- 通知过滤（仅重要邮件）
- 免打扰模式
- 通知历史记录

#### 非功能需求
- 通知延迟 < 5秒
- 支持后台运行
- 低资源占用（< 50MB内存）
- 跨平台兼容

### 3.3 技术架构

#### 3.3.1 模块结构

```
src/notifications/
├── index.js              # 通知系统主入口
├── manager.js            # 通知管理器
├── providers/            # 通知提供者
│   ├── desktop.js        # 桌面通知（node-notifier）
│   ├── sound.js          # 声音通知
│   └── console.js        # 控制台通知（fallback）
├── filters.js            # 通知过滤器
├── scheduler.js          # 通知调度器
└── config.js             # 通知配置
```

#### 3.3.2 核心类设计

**NotificationManager类**
```javascript
class NotificationManager {
  constructor(config)

  // 通知发送
  notify(email, options)        // 发送通知
  notifyBatch(emails)           // 批量通知

  // 配置管理
  enable()                      // 启用通知
  disable()                     // 禁用通知
  setDndMode(enabled, until)    // 设置免打扰模式

  // 过滤器
  addFilter(filter)             // 添加过滤规则
  removeFilter(filterId)        // 移除过滤规则

  // 历史记录
  getHistory(limit)             // 获取通知历史
  clearHistory()                // 清空历史
}
```

**NotificationFilter类**
```javascript
class NotificationFilter {
  constructor(rules)

  shouldNotify(email)           // 判断是否应该通知
  matchRules(email, rules)      // 匹配过滤规则
}
```

### 3.4 数据库Schema设计

#### notification_settings表
```sql
CREATE TABLE notification_settings (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  enabled BOOLEAN DEFAULT 1,
  desktop_enabled BOOLEAN DEFAULT 1,
  sound_enabled BOOLEAN DEFAULT 1,
  sound_file TEXT,
  dnd_enabled BOOLEAN DEFAULT 0,
  dnd_until DATETIME,
  filter_rules TEXT,            -- JSON，过滤规则
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 通知历史表
CREATE TABLE notification_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email_id INTEGER NOT NULL,
  notification_type TEXT,       -- desktop, sound, console
  title TEXT,
  message TEXT,
  notified_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (email_id) REFERENCES emails(id) ON DELETE CASCADE
);

CREATE INDEX idx_notification_history_email ON notification_history(email_id);
CREATE INDEX idx_notification_history_date ON notification_history(notified_at);
```

### 3.5 CLI命令设计

#### 通知管理命令
```bash
# 启用/禁用通知
mail-client notify enable
mail-client notify disable

# 查看通知设置
mail-client notify status

# 配置通知
mail-client notify config
mail-client notify config --desktop on --sound off

# 免打扰模式
mail-client notify dnd on
mail-client notify dnd on --until "2026-02-08 18:00"
mail-client notify dnd off

# 通知过滤规则
mail-client notify filter add --from important@company.com
mail-client notify filter add --subject "urgent"
mail-client notify filter list
mail-client notify filter remove <id>

# 查看通知历史
mail-client notify history
mail-client notify history --limit 20

# 后台监听模式
mail-client notify watch
mail-client notify watch --interval 60  # 每60秒检查一次
```

### 3.6 通知提供者实现

#### 桌面通知（node-notifier）
```javascript
const notifier = require('node-notifier');

function sendDesktopNotification(email) {
  notifier.notify({
    title: `New Email from ${email.from_address}`,
    message: email.subject,
    icon: path.join(__dirname, 'assets', 'mail-icon.png'),
    sound: false,  // 由sound provider处理
    wait: true,
    timeout: 10
  });
}
```

#### 声音通知
```javascript
const player = require('play-sound')();

function playSoundNotification(soundFile) {
  player.play(soundFile || 'default-notification.mp3', (err) => {
    if (err) logger.error('Failed to play sound', err);
  });
}
```

### 3.7 通知过滤规则

#### 规则类型
```javascript
{
  type: 'from',           // 发件人过滤
  value: 'boss@company.com',
  action: 'allow'         // allow | block
}

{
  type: 'subject',        // 主题关键词
  value: 'urgent',
  action: 'allow'
}

{
  type: 'folder',         // 文件夹过滤
  value: 'INBOX',
  action: 'allow'
}

{
  type: 'has_attachments', // 有附件
  value: true,
  action: 'allow'
}
```

### 3.8 后台监听实现

#### 同步调度器集成
```javascript
// 在sync scheduler中集成通知
class SyncScheduler {
  async syncAndNotify() {
    const newEmails = await this.sync();

    if (newEmails.length > 0) {
      await notificationManager.notifyBatch(newEmails);
    }
  }
}
```

#### 独立监听进程
```bash
# 启动后台监听
mail-client notify watch --daemon

# 停止后台监听
mail-client notify stop
```

### 3.9 实现要点

1. **跨平台兼容**
   - 使用 node-notifier 支持多平台
   - 提供 fallback 机制（console输出）

2. **性能优化**
   - 批量通知合并
   - 通知频率限制（防止通知轰炸）
   - 异步非阻塞

3. **用户体验**
   - 通知可点击跳转到邮件
   - 支持快速操作（标记已读、删除）
   - 免打扰时段自动管理

4. **安全考虑**
   - 通知内容脱敏选项
   - 敏感邮件不显示预览

### 3.10 与现有系统集成

#### 集成点
1. **与同步系统集成**
   - 在 sync 完成后触发通知
   - 检测新邮件（通过 UID 比对）

2. **与过滤系统集成**
   - 复用 filters 模块的规则引擎
   - 共享过滤规则配置

3. **与配置系统集成**
   - 通知设置存储在配置文件
   - 使用现有 ConfigManager

---

## 4. 邮件导入导出功能

### 4.1 功能概述

邮件导入导出功能支持将邮件导出为标准格式（EML、MBOX），以及从其他邮件客户端导入邮件，实现数据迁移和备份。

### 4.2 需求分析

#### 核心需求
- 导出单封邮件为EML格式
- 导出多封邮件为MBOX格式
- 批量导出（按文件夹、日期范围）
- 从EML文件导入
- 从MBOX文件导入
- 导出/导入附件
- 数据库完整备份

#### 非功能需求
- 支持大文件（> 1GB）
- 导入导出进度显示
- 数据完整性验证
- 错误恢复机制

### 4.3 技术架构

#### 4.3.1 模块结构

```
src/import-export/
├── index.js              # 导入导出主入口
├── exporter.js           # 导出管理器
├── importer.js           # 导入管理器
├── formats/              # 格式处理器
│   ├── eml.js            # EML格式处理
│   ├── mbox.js           # MBOX格式处理
│   └── json.js           # JSON格式（备份用）
├── validator.js          # 数据验证
└── progress.js           # 进度跟踪
```

#### 4.3.2 核心类设计

**Exporter类**
```javascript
class Exporter {
  constructor(db)

  // 单封邮件导出
  exportToEml(emailId, outputPath)

  // 批量导出
  exportToMbox(emailIds, outputPath)
  exportFolder(folder, outputPath, format)
  exportDateRange(startDate, endDate, outputPath, format)

  // 完整备份
  exportAll(outputPath, options)

  // 附件导出
  exportAttachments(emailId, outputDir)
}
```

**Importer类**
```javascript
class Importer {
  constructor(db)

  // 单封邮件导入
  importFromEml(emlPath, folder)

  // 批量导入
  importFromMbox(mboxPath, folder)
  importFromDirectory(dirPath, folder)

  // 完整恢复
  importBackup(backupPath)

  // 验证
  validateImport(filePath)
}
```

### 4.4 数据库Schema设计

#### import_export_logs表
```sql
CREATE TABLE import_export_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  operation TEXT NOT NULL,      -- import | export
  format TEXT NOT NULL,          -- eml | mbox | json
  file_path TEXT NOT NULL,
  email_count INTEGER DEFAULT 0,
  success_count INTEGER DEFAULT 0,
  error_count INTEGER DEFAULT 0,
  status TEXT DEFAULT 'pending', -- pending | running | completed | failed
  error_message TEXT,
  started_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  completed_at DATETIME
);

CREATE INDEX idx_import_export_logs_operation ON import_export_logs(operation);
CREATE INDEX idx_import_export_logs_status ON import_export_logs(status);
```

### 4.5 CLI命令设计

#### 导出命令
```bash
# 导出单封邮件为EML
mail-client export eml <email-id> --output ./email.eml

# 导出文件夹为MBOX
mail-client export mbox --folder INBOX --output ./inbox.mbox

# 导出日期范围
mail-client export mbox --from 2026-01-01 --to 2026-01-31 --output ./january.mbox

# 导出所有邮件
mail-client export all --output ./backup --format mbox

# 仅导出附件
mail-client export attachments <email-id> --output ./attachments/

# 完整备份（包括数据库）
mail-client backup --output ./full-backup.zip
```

#### 导入命令
```bash
# 从EML导入
mail-client import eml ./email.eml --folder INBOX

# 从MBOX导入
mail-client import mbox ./inbox.mbox --folder INBOX

# 批量导入目录中的EML文件
mail-client import dir ./emails/ --folder INBOX

# 恢复完整备份
mail-client restore ./full-backup.zip

# 验证导入文件
mail-client import validate ./inbox.mbox
```

### 4.6 格式处理实现

#### EML格式
```javascript
// 导出为EML
function exportToEml(email) {
  const eml = [
    `From: ${email.from_address}`,
    `To: ${email.to_address}`,
    `Subject: ${email.subject}`,
    `Date: ${email.date}`,
    `Message-ID: ${email.message_id}`,
    ``,
    email.body_text || email.body_html
  ].join('\r\n');

  return eml;
}

// 从EML导入
function importFromEml(emlContent) {
  const parsed = mailparser.simpleParser(emlContent);
  return {
    from_address: parsed.from.text,
    to_address: parsed.to.text,
    subject: parsed.subject,
    date: parsed.date,
    body_text: parsed.text,
    body_html: parsed.html,
    attachments: parsed.attachments
  };
}
```

#### MBOX格式
```javascript
// MBOX格式：多封邮件连接，以"From "开头分隔
function exportToMbox(emails) {
  const mbox = emails.map(email => {
    return [
      `From ${email.from_address} ${email.date}`,
      exportToEml(email),
      ''
    ].join('\r\n');
  }).join('\r\n');

  return mbox;
}

// 从MBOX导入
function importFromMbox(mboxContent) {
  const emails = mboxContent.split(/\r?\nFrom /);
  return emails.map(emlContent => importFromEml(emlContent));
}
```

### 4.7 进度跟踪

#### 进度显示
```javascript
const ora = require('ora');

class ProgressTracker {
  constructor(total) {
    this.total = total;
    this.current = 0;
    this.spinner = ora(`Processing 0/${total}`).start();
  }

  update(current) {
    this.current = current;
    this.spinner.text = `Processing ${current}/${this.total}`;
  }

  complete() {
    this.spinner.succeed(`Completed ${this.total}/${this.total}`);
  }

  fail(error) {
    this.spinner.fail(`Failed: ${error.message}`);
  }
}
```

### 4.8 实现要点

1. **大文件处理**
   - 流式读写，避免内存溢出
   - 分批处理（每批100封邮件）
   - 断点续传支持

2. **数据完整性**
   - 导出前验证数据
   - 导入后校验邮件数量
   - MD5校验和

3. **错误处理**
   - 记录失败的邮件
   - 提供重试机制
   - 生成错误报告

4. **性能优化**
   - 并行处理（worker threads）
   - 压缩导出文件
   - 索引优化

5. **兼容性**
   - 支持Thunderbird MBOX格式
   - 支持Outlook PST（未来扩展）
   - 标准EML格式

### 4.9 备份策略

#### 完整备份
```javascript
async function createFullBackup(outputPath) {
  const backup = {
    version: '1.0',
    timestamp: new Date().toISOString(),
    database: await exportDatabase(),
    attachments: await exportAllAttachments(),
    config: await exportConfig()
  };

  // 压缩为ZIP
  await createZip(backup, outputPath);
}
```

#### 增量备份（未来扩展）
- 仅备份自上次备份后的新邮件
- 记录备份点
- 支持增量恢复

### 4.10 与现有系统集成

#### 集成点
1. **与存储系统集成**
   - 使用现有 DatabaseManager
   - 复用 emails 和 attachments 表

2. **与IMAP系统集成**
   - 导入后可选择同步到服务器
   - 保持UID一致性

3. **与CLI系统集成**
   - 新增 `export` 和 `import` 命令组
   - 使用现有进度显示工具（ora）

---

## 5. 数据库迁移计划

### 5.1 新增表总结

```sql
-- P2功能新增表
CREATE TABLE templates (...);
CREATE TABLE notification_settings (...);
CREATE TABLE notification_history (...);
CREATE TABLE import_export_logs (...);
```

### 5.2 迁移文件

创建 `src/storage/migrations/003_p2_features.js`：

```javascript
function up(db) {
  // 创建templates表
  db.exec(`CREATE TABLE IF NOT EXISTS templates (...)`);

  // 创建notification_settings表
  db.exec(`CREATE TABLE IF NOT EXISTS notification_settings (...)`);

  // 创建notification_history表
  db.exec(`CREATE TABLE IF NOT EXISTS notification_history (...)`);

  // 创建import_export_logs表
  db.exec(`CREATE TABLE IF NOT EXISTS import_export_logs (...)`);

  // 创建索引
  db.exec(`CREATE INDEX ...`);
}

function down(db) {
  db.exec('DROP TABLE IF EXISTS import_export_logs;');
  db.exec('DROP TABLE IF EXISTS notification_history;');
  db.exec('DROP TABLE IF EXISTS notification_settings;');
  db.exec('DROP TABLE IF EXISTS templates;');
}

module.exports = { up, down };
```

---

## 6. 依赖库清单

### 6.1 新增依赖

```json
{
  "dependencies": {
    "node-notifier": "^10.0.1",      // 桌面通知
    "play-sound": "^1.1.6",          // 声音播放
    "mailparser": "^3.6.5",          // 邮件解析（已有）
    "archiver": "^6.0.1",            // ZIP压缩
    "unzipper": "^0.10.14",          // ZIP解压
    "stream-json": "^1.8.0"          // 流式JSON处理
  }
}
```

### 6.2 可选依赖

```json
{
  "optionalDependencies": {
    "node-wav-player": "^0.2.0"      // WAV音频播放（跨平台）
  }
}
```

---

## 7. 开发计划

### 7.1 开发顺序

**阶段1：邮件模板系统（3-4天）**
1. Day 1: 数据库schema + TemplateManager基础CRUD
2. Day 2: TemplateParser变量系统
3. Day 3: CLI命令实现
4. Day 4: 测试和文档

**阶段2：新邮件通知系统（3-4天）**
1. Day 1: NotificationManager + 桌面通知
2. Day 2: 过滤器和免打扰模式
3. Day 3: 后台监听和同步集成
4. Day 4: 测试和文档

**阶段3：邮件导入导出（4-5天）**
1. Day 1: EML格式导入导出
2. Day 2: MBOX格式导入导出
3. Day 3: 批量操作和进度跟踪
4. Day 4: 完整备份功能
5. Day 5: 测试和文档

**总计：10-13天**

### 7.2 里程碑

- **M1**: 模板系统可用（Day 4）
- **M2**: 通知系统可用（Day 8）
- **M3**: 导入导出可用（Day 13）
- **M4**: 完整测试和文档（Day 15）

---

## 8. 测试计划

### 8.1 单元测试

**模板系统**
- 模板CRUD操作
- 变量解析和替换
- 模板验证

**通知系统**
- 通知发送
- 过滤规则匹配
- 免打扰模式

**导入导出**
- EML格式转换
- MBOX格式转换
- 数据完整性验证

### 8.2 集成测试

- 模板与发送命令集成
- 通知与同步系统集成
- 导入导出与数据库集成

### 8.3 性能测试

- 1000+模板管理性能
- 大量邮件通知性能
- 大文件（1GB+）导入导出

---

## 9. 文档计划

### 9.1 用户文档

- 模板系统使用指南
- 通知系统配置指南
- 导入导出操作手册

### 9.2 开发文档

- API文档
- 模块设计文档
- 数据库schema文档

---

## 10. 风险和挑战

### 10.1 技术风险

1. **跨平台兼容性**
   - 风险：不同操作系统通知机制差异
   - 缓解：使用成熟的node-notifier库，提供fallback

2. **大文件处理**
   - 风险：导入导出大文件可能内存溢出
   - 缓解：使用流式处理，分批操作

3. **数据完整性**
   - 风险：导入导出过程中数据损坏
   - 缓解：添加校验和，事务处理

### 10.2 用户体验风险

1. **通知轰炸**
   - 风险：大量新邮件导致通知过多
   - 缓解：通知频率限制，批量合并

2. **模板复杂度**
   - 风险：变量系统过于复杂
   - 缓解：提供简单的默认模板，渐进式学习

---

## 11. 未来扩展

### 11.1 模板系统扩展

- 模板市场（共享模板）
- 条件渲染（if/else）
- 循环渲染（for loops）
- 模板继承

### 11.2 通知系统扩展

- 邮件摘要通知（每小时汇总）
- 移动端推送（通过API）
- 自定义通知声音
- 通知优先级

### 11.3 导入导出扩展

- Outlook PST格式支持
- Gmail Takeout支持
- 云端备份（S3, Google Drive）
- 自动定时备份

---

## 12. 总结

本技术设计文档详细规划了P2功能的三个核心模块：

1. **邮件模板系统** - 提供灵活的模板管理和变量替换，提高邮件撰写效率
2. **新邮件通知系统** - 实时通知用户新邮件，支持过滤和免打扰
3. **邮件导入导出功能** - 支持标准格式的数据迁移和备份

所有功能均采用模块化设计，与现有系统良好集成，为后续P3功能奠定基础。

---

**文档结束**

*本文档将随着开发进度持续更新*
